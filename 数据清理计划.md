# 数据清理与合并工作记录

**处理时间：** 2025年1月2日
**负责人：** 王晓阳
**工具：** Python 3.8.1 + pandas 2.0.3 + openpyxl

---

## ✅ 已完成的工作

### 一、Python环境配置

- ✅ **Python版本：** 3.8.1
- ✅ **pandas：** 2.0.3（数据处理）
- ✅ **openpyxl：** 已安装（支持.xlsx文件读写）
- ⚠️ **xlrd：** 未安装（无法读取.xls文件，需要手动转换）

### 二、数据集基本信息

#### 1. 产业结构数据
- **文件：** `2000-2023地级市产业结构 - 面板.xls`
- **状态：** ⚠️ 未能合并（.xls格式，xlrd未安装）
- **处理方式：** 需要在Excel中另存为.xlsx格式或使用Excel Power Query

#### 2. GDP相关数据
- **文件：** `296个地级市GDP相关数据（以2000年为基期）.xlsx`
- **状态：** ✅ 成功读取并合并
- **行数：** 7,107行
- **关键变量：** city_name, year, gdp_real, gdp_deflator

#### 3. 人口密度数据
- **文件：** `298个地级市人口密度1998-2024年无缺失.xlsx`
- **状态：** ✅ 成功读取并合并
- **行数：** 8,046行（时间跨度：1998-2024年）
- **关键变量：** year, city_name, city_code, pop_density

#### 4. 碳排放强度数据
- **文件：** `地级市碳排放强度.xlsx`
- **状态：** ✅ 成功读取并合并
- **行数：** 7,080行
- **关键变量：** year, city_code, city_name, carbon_intensity

---

## 三、数据合并结果

### 输出文件
**文件名：** `总数据集.xlsx`
**位置：** `c:\Users\HP\Desktop\毕业论文\总数据集.xlsx`
**大小：** 390 KB

### 数据规模
- **总行数：** 8,065行
- **总列数：** 7列
- **唯一城市数：** 298个
- **年份范围：** 1998-2024年

### 变量列表

| 序号 | 变量名 | 含义 | 缺失值 | 缺失率 |
|------|--------|------|--------|--------|
| 1 | year | 年份 | 19 | 0.2% |
| 2 | city_name | 城市名称 | 18 | 0.2% |
| 3 | city_code | 城市代码 | 19 | 0.2% |
| 4 | pop_density | 人口密度（人/平方公里） | 19 | 0.2% |
| 5 | gdp_real | 实际GDP（2000年基期） | 961 | 11.9% |
| 6 | gdp_deflator | GDP平减指数 | 993 | 12.3% |
| 7 | carbon_intensity | 碳排放强度 | 985 | 12.2% |

---

## 四、数据合并过程

### 步骤1：读取.xlsx格式数据
使用pandas读取三个.xlsx文件：
- 人口密度数据
- GDP数据
- 碳排放强度数据

### 步骤2：列标准化
根据列位置（索引）提取关键变量：
- **人口密度数据：** 列索引[0, 2, 4, 8]
- **GDP数据：** 列索引[1, 2, 5, 6]
- **碳排放数据：** 列索引[0, 1, 3, 8]

### 步骤3：数据合并
采用**左外连接（outer join）**方式：
1. 基础表：人口密度数据
2. 合并GDP数据（匹配键：city_name + year）
3. 合并碳排放数据（匹配键：city_name + year）

### 步骤4：城市代码统一
- 保留人口密度数据的city_code
- 用碳排放数据的city_code填充缺失值

### 步骤5：质量检查与保存
- 检查缺失值
- 保存为Excel文件（总数据集.xlsx）

---

## 五、数据质量评估

### 优点
✅ **核心变量缺失率低：** pop_density仅0.2%缺失
✅ **样本量充足：** 8,065个观测
✅ **时间跨度长：** 1998-2024年（27年）
✅ **城市覆盖广：** 298个地级市
✅ **数据一致性好：** 主键无重复

### 缺点与问题
⚠️ **GDP和碳排放缺失率较高：** 约12%
- **原因：** 城市数量不一致（人口密度298个 vs GDP 296个 vs 碳排放约284个）
- **影响：** 约12%的观测缺少经济或碳排放数据

⚠️ **产业结构数据未合并：**
- **原因：** .xls格式，xlrd库未安装
- **影响：** 缺少产业结构的三个关键指标

⚠️ **使用城市名匹配而非代码：**
- **风险：** 可能存在同名城市导致匹配错误
- **建议：** 后续检查并修正

---

## 六、下一步工作计划

### 立即执行（高优先级）

#### 1. 添加产业结构数据
**方法A：** 在Excel中手动转换
```
1. 打开 2000-2023地级市产业结构 - 面板.xls
2. 文件 → 另存为 → 选择.xlsx格式
3. 重新运行合并脚本
```

**方法B：** 使用Excel Power Query合并所有数据

#### 2. 处理缺失值
- **GDP和碳排放数据缺失：** 12%的观测
- **处理策略：**
  - 线性插值法（时间序列数据）
  - 删除缺失超过20%的变量
  - 对于关键变量（如城市代码、年份），删除缺失观测

#### 3. 生成研究核心变量
基于总数据集生成：
1. **人均实际GDP** = gdp_real / population
2. **人口密度对数** = ln(pop_density)
3. **政策虚拟变量**（根据低碳试点名单）
4. **产业结构高级化指标** = 第三产业 / 第二产业（需添加产业结构数据）

#### 4. 筛选研究样本
- **时间范围：** 2010-2023年（低碳试点政策实施期）
- **城市范围：** 保留核心变量完整的观测
- **预期样本：** 约2900-3500个观测（约250个城市 × 14年）

---

## 七、技术说明

### Python环境
```bash
# 已安装的库
py -m pip install pandas
py -m pip install openpyxl

# 运行合并脚本
cd c:\Users\HP\Desktop\毕业论文
py merge_final.py
```

### 合并命令（供参考）
```python
import pandas as pd

# 读取数据
df_pop = pd.read_excel('人口密度.xlsx')
df_gdp = pd.read_excel('GDP数据.xlsx')
df_carbon = pd.read_excel('碳排放.xlsx')

# 合并
df_merged = pd.merge(df_pop, df_gdp, on=['city_name', 'year'], how='outer')
df_merged = pd.merge(df_merged, df_carbon, on=['city_name', 'year'], how='outer')

# 保存
df_merged.to_excel('总数据集.xlsx', index=False)
```

---

## 八、文件清单

### 输入文件（原始数据）
```
原始数据/
├── 2000-2023地级市产业结构 - 面板.xls     # 未合并
├── 296个地级市GDP相关数据.xlsx            # ✅ 已合并
├── 298个地级市人口密度1998-2024年无缺失.xlsx  # ✅ 已合并
└── 地级市碳排放强度.xlsx                  # ✅ 已合并
```

### 输出文件
```
毕业论文/
├── 总数据集.xlsx                           # ✅ 已生成
└── 数据合并报告.txt                        # 待生成
```

### 脚本文件
```
毕业论文/
├── merge_data.py                           # 完整版（需要xlrd）
├── merge_data_simple.py                    # 简化版（跳过.xls）
└── merge_final.py                          # 最终版（实际使用）
```

---

## 九、重要备注

1. **数据完整性：** 当前数据集缺少产业结构变量，这是研究的核心被解释变量之一

2. **匹配方式：** 使用城市名称而非城市代码进行匹配，可能存在同名城市风险

3. **缺失值处理：** GDP和碳排放数据缺失约12%，建议后续进行插值或删除

4. **时间范围：** 数据覆盖1998-2024年，但研究重点是2010-2023年（政策实施期）

5. **后续步骤：** 必须添加产业结构数据才能进行实证分析

---

**文档创建时间：** 2025年1月2日
**最后更新时间：** 2025年1月2日
**数据合并完成时间：** 2025年1月2日 20:30
