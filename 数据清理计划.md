# 数据清理与合并工作记录

**处理时间：** 2025年1月2日
**负责人：** 王晓阳
**工具：** Python + pandas

---

## 一、数据集基本信息

### 1. 产业结构数据
- **文件：** `2000-2023地级市产业结构 - 面板.xls`
- **大小：** 2.3 MB
- **时间范围：** 2000-2023年
- **样本数量：** 330个地级市

### 2. GDP相关数据
- **文件：** `296个地级市GDP相关数据（以2000年为基期）.xlsx`
- **大小：** 395 KB
- **样本数量：** 296个地级市
- **说明：** 以2000年为基期的GDP平减指数数据

### 3. 人口密度数据
- **文件：** `298个地级市人口密度1998-2024年无缺失.xlsx`
- **大小：** 512 KB
- **时间范围：** 1998-2024年
- **样本数量：** 298个地级市
- **特点：** 无缺失值，已插值处理

### 4. 碳排放强度数据
- **文件：** `地级市碳排放强度.xlsx`
- **大小：** 521 KB
- **说明：** 地级市层面的碳排放强度指标

---

## 二、数据合并处理流程

### 步骤1：数据加载与初步检查

**操作说明：**
由于Python环境未正确配置，当前采用手工分析方法。需要：
1. 识别每个数据集的主键列（城市代码、年份）
2. 统一主键列的命名规范
3. 确定数据集之间的连接方式

**识别的主键列（需手动确认）：**

#### 产业结构数据
- 预期主键：城市代码、年份
- 可能的列名：
  - 城市代码 / 城市代码
  - 年度 / 年份 / 年

#### 人口密度数据
- 预期主键：城市代码、年份
- 可能的列名：
  - 城市代码 / City_Code
  - 年份 / Year

#### GDP数据
- 预期主键：城市代码、年份
- 可能的列名：
  - 城市代码
  - 年份

#### 碳排放数据
- 预期主键：城市代码、年份
- 可能的列名：
  - 城市代码
  - 年份

### 步骤2：主键列标准化（待执行）

**目标：** 将所有数据集的主键列统一为标准格式

**标准化规则：**
1. 城市代码列 → 统一命名为 `city_code`（6位行政区划代码）
2. 年份列 → 统一命名为 `year`（4位数字，如2010）
3. 城市名称列 → 统一命名为 `city_name`（用于验证匹配）

**操作步骤：**
```
对每个数据集：
1. 重命名主键列
2. 检查数据类型（city_code应为字符串或数值，year应为数值）
3. 检查唯一性（city_code + year组合应唯一）
```

### 步骤3：数据合并（待执行）

**合并策略：**
- 以**产业结构数据（330个城市）**为基础表
- 依次左连接其他数据集

**合并顺序：**
```
1. 基础表：产业结构数据（2000-2023）
2. 左连接：GDP数据（by=['city_code', 'year']）
3. 左连接：人口密度数据（by=['city_code', 'year']）
4. 左连接：碳排放数据（by=['city_code', 'year']）
```

**预期结果：**
- 总数据集：约290-300个城市（取交集）
- 时间范围：2010-2023年（核心研究期）
- 观测数量：约3500-4000条记录（城市数 × 年份数）

### 步骤4：数据质量检查（待执行）

**检查项目：**
1. ✅ 主键唯一性检查
   ```python
   df.duplicated(subset=['city_code', 'year']).sum()
   ```

2. ✅ 缺失值统计
   ```python
   df.isnull().sum()
   ```

3. ✅ 时间范围一致性
   ```python
   print(df['year'].min(), df['year'].max())
   ```

4. ✅ 城市数量统计
   ```python
   print(df['city_code'].nunique())
   ```

5. ✅ 关键变量描述统计
   ```python
   df.describe()
   ```

### 步骤5：生成总数据集（待执行）

**输出文件：** `总数据集.xlsx`

**包含变量清单：**

#### 主键变量
- `city_code`：城市代码（6位）
- `city_name`：城市名称
- `province`：省份名称
- `year`：年份

#### 经济发展变量
- `gdp`：地区生产总值（亿元）
- `gdp_real`：实际GDP（2000年基期，亿元）
- `gdp_per_capita`：人均GDP（元）
- `gdp_deflator`：GDP平减指数

#### 产业结构变量
- `primary_industry`：第一产业增加值（亿元）
- `secondary_industry`：第二产业增加值（亿元）
- `tertiary_industry`：第三产业增加值（亿元）
- `primary_share`：第一产业占GDP比重（%）
- `secondary_share`：第二产业占GDP比重（%）
- `tertiary_share`：第三产业占GDP比重（%）
- `ind_structure`：产业结构水平（第三产业/GDP）
- `ind_upgrade`：产业整体升级指数
- `ind_advancement`：产业结构高级化（第三产业/第二产业）

#### 人口变量
- `population_density`：人口密度（人/平方公里）
- `ln_population_density`：人口密度对数

#### 碳排放变量
- `carbon_emissions`：碳排放总量（吨）
- `carbon_intensity`：碳排放强度（吨/万元GDP）

#### 政策变量（待生成）
- `is_pilot_city`：是否为低碳试点城市（0/1）
- `policy_year`：政策实施年份（2010/2012/2017）
- `did`：双重差分项（is_pilot_city × post）

---

## 三、当前状态

### ✅ 已完成
- [x] 数据收集与整理
- [x] 数据文件位置确认
- [x] 初步数据结构分析

### ⏳ 进行中
- [ ] Python环境配置
- [ ] 数据文件读取与主键识别
- [ ] 主键列标准化
- [ ] 数据集合并
- [ ] 质量检查
- [ ] 生成总数据集Excel文件

### ⏸️ 待执行
- [ ] 变量描述性统计
- [ ] 数据清洗日志记录
- [ ] 可视化图表制作
- [ ] 合并后数据验证

---

## 四、遇到的问题与解决方案

### 问题1：Python环境未正确配置
**现象：** 运行`python`命令返回错误代码49
**原因：** Windows应用商店的Python别名未正确安装pandas等库
**解决方案：**
1. 需要安装完整的Python环境（推荐Anaconda）
2. 或使用Excel Power Query进行合并
3. 或使用Stata/SPSS等统计软件

### 问题2：数据文件格式不统一
**现象：** 四个数据集分别为.xls和.xlsx格式
**影响：** 需要使用不同的读取引擎
**解决方案：** pandas可自动处理，但需确保openpyxl和xlrd库已安装

### 问题3：主键列命名不统一
**现象：** 不同数据集可能使用不同的列名表示城市代码和年份
**解决方案：**
- 编写智能识别脚本（基于关键词匹配）
- 或手动重命名后再合并

---

## 五、下一步工作计划

### 立即执行（优先级：高）
1. **配置数据分析环境**
   - 安装Anaconda或Miniconda
   - 配置pandas、openpyxl、xlrd等库

2. **手工识别主键列**
   - 打开每个Excel文件
   - 确认城市代码和年份列的准确名称
   - 记录在本文档中

3. **执行数据合并**
   - 编写Python脚本
   - 按主键合并四个数据集
   - 生成`总数据集.xlsx`

### 后续工作（优先级：中）
4. **数据质量检查**
   - 检查缺失值
   - 检查异常值
   - 检查数据一致性

5. **生成描述统计**
   - 制作变量说明表
   - 计算描述性统计量
   - 绘制时间趋势图

6. **构建政策变量**
   - 根据三批试点名单生成政策虚拟变量
   - 生成DID交互项

---

## 六、备注

**数据文件路径：**
```
c:\Users\HP\Desktop\毕业论文\原始数据\
├── 2000-2023地级市产业结构 - 面板.xls
├── 296个地级市GDP相关数据（以2000年为基期）.xlsx
├── 298个地级市人口密度1998-2024年无缺失.xlsx
└── 地级市碳排放强度.xlsx
```

**输出路径：**
```
c:\Users\HP\Desktop\毕业论文\总数据集.xlsx
```

**联系方式：**
- 数据问题：查阅数据来源文件`数据说明.txt`
- 技术问题：参考`CLAUDE.md`和`实验思路md`

---

**文档创建：** 2025年1月2日
**最后更新：** 2025年1月2日
