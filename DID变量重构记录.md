# DID变量重构工作记录

**日期**: 2026年1月9日
**任务**: 修复DID政策变量中的省市重叠问题、年份滞后和数据遗漏问题

---

## 一、问题诊断

### 1.1 核心问题

通过诊断发现现有DID变量存在以下**四大问题**：

#### 问题1: 省市重叠导致年份滞后
- **现象**: 武汉市、广州市、昆明市等省会城市被错误标记为2013年（第二批）
- **原因**: 这些城市既属于第一批试点省份（湖北2010、广东2010、云南2010），又被列入第二批试点城市名单
- **旧逻辑缺陷**: 后处理的城市名单覆盖了先处理的省级试点赋值（"后覆盖前"）
- **影响**: 6个省级试点省份的省会城市年份错误滞后

#### 问题2: 第二批试点启动年份不准确
- **现象**: 第二批试点统一设定为2013年
- **实际情况**: 第二批低碳试点于**2012年4月**启动
- **影响**: 时间基准不准确，无法捕捉2012年当年政策效应

#### 问题3: 第三批试点城市遗漏
- **现象**: 第三批试点名单缺少西部城市
- **遗漏城市**: 拉萨市、伊宁市、和田市
- **影响**: 西部地区样本代表性不足

#### 问题4: 区县级试点名称错误
- **现象**: "普洱市思茅区"出现在第三批名单中
- **问题**: 研究使用地级市面板数据，区县级名称无法匹配
- **正确处理**: 应映射为地级市"普洱市"

### 1.2 修复前后对比

| 城市 | 修复前pilot_year | 修复后pilot_year | 变化 |
|------|-----------------|-----------------|------|
| 武汉市 | 2013 | 2010 | **-3年** |
| 广州市 | 2013 | 2010 | **-3年** |
| 昆明市 | 2013 | 2010 | **-3年** |
| 北京市 | 2013 | 2012 | -1年 |
| 上海市 | 2013 | 2012 | -1年 |
| 拉萨市 | NaN | 2017 | 新增 |
| 伊宁市 | NaN | 2017 | 新增 |
| 和田市 | NaN | 2017 | 新增 |

---

## 二、解决方案

### 2.1 核心逻辑改进

#### 旧逻辑（错误）
```python
# 先处理明确城市名单
for city_name in batch_1_cities:
    city_to_pilot_year[city_name] = 2010

# 后处理省级试点（会覆盖前面的赋值）
for province_code in batch_1_provinces:
    for city_name in cities_in_province:
        city_to_pilot_year[city_name] = 2010  # 但这里不会覆盖已存在的
```

#### 新逻辑（正确）
```python
# 【优先处理】省级试点（最早年份优先）
for province_code in batch_1_provinces:
    for city_name in cities_in_province:
        city_to_pilot_year[city_name] = 2010  # 直接赋值

# 【后处理】明确城市名单（只赋值给未赋值的）
for city_name in batch_1_cities:
    if city_name not in city_to_pilot_year:
        city_to_pilot_year[city_name] = 2010  # 不会覆盖省级赋值
```

**关键原则**: **"谁早听谁的"**（Min-Year原则）
- 省级试点优先处理（2010年权重最高）
- 明确城市名单后处理，只赋值给未赋值的城市
- 确保省会城市保留最早的试点年份

### 2.2 批次年份修正

| 批次 | 修复前年份 | 修复后年份 | 依据 |
|------|----------|----------|------|
| 第一批 | 2010 | 2010 | 2010年7月启动 |
| 第二批 | 2013 | **2012** | **2012年4月启动** |
| 第三批 | 2017 | 2017 | 2017年启动 |

### 2.3 名单补全与修正

#### 第三批新增城市
- 拉萨市（西藏）
- 伊宁市（新疆）
- 和田市（新疆）

#### 区县级名称映射
- `普洱市思茅区` → `普洱市`（地级市）

---

## 三、实施过程

### 3.1 新建脚本
创建 `py代码文件/reconstruct_did_variable.py`，核心改进：

1. **省级试点优先处理**
   ```python
   # 第一批省级试点（2010年）
   for province_code in batch_1_provinces:
       cities_in_province = df[df['province_code'] == province_code]['city_name'].unique()
       for city_name in cities_in_province:
           city_to_pilot_year[city_name] = 2010  # 直接赋值
   ```

2. **明确名单后处理**
   ```python
   # 第二批明确城市（2012年）
   for city_name in batch_2_cities:
       if city_name not in city_to_pilot_year:  # 关键：检查是否已赋值
           city_to_pilot_year[city_name] = 2012
   ```

3. **年份修正**
   ```python
   batch_2_cities = [..., '武汉市', '广州市', ...]  # 这些城市已在第一批省级试点赋值
   # 此处if判断会跳过它们，保持2010年不变
   ```

4. **补全遗漏城市**
   ```python
   batch_3_cities = [
       ...
       '乌鲁木齐市', '昌吉市',
       '拉萨市',  # 新增
       '伊宁市',  # 新增
       '和田市',  # 新增
   ]
   ```

### 3.2 执行脚本

```bash
py py代码文件/reconstruct_did_variable.py
```

**执行结果**:
```
数据规模: (3672, 25)
城市数: 216

删除旧变量: treat, post, did, pilot_year

[优先处理] 省级试点覆盖...
  广东省（44）: 21个城市
  辽宁省（21）: 0个城市
  湖北省（42）: 9个城市
  陕西省（61）: 5个城市
  云南省（53）: 8个城市
  -> 第一批省级试点后: 43个城市已赋值

  海南省（46）: 2个城市
  -> 第二批省级试点后: 45个城市已赋值

[后处理] 明确列出的试点城市...
  第一批城市名单后: 52个城市已赋值
  第二批城市名单后: 76个城市已赋值
  第三批城市名单后: 115个城市已赋值

试点城市总数: 115
（注：实际数据集匹配到93个城市）
```

### 3.3 验证修复效果

#### 关键城市验证
```
[验证] 关键城市试点年份检查:
  武汉市: 2010年 ✓
  广州市: 2010年 ✓
  昆明市: 2010年 ✓
  北京市: 2012年 ✓
  上海市: 2012年 ✓
  拉萨市: 2017年 ✓
  伊宁市: 2017年 ✓
  和田市: 2017年 ✓
```

#### 省市重叠问题解决检查
```
[检查] 省市重叠问题解决情况:
  武汉市: pilot_year=2010 (期望2010) [OK]
  广州市: pilot_year=2010 (期望2010) [OK]
  昆明市: pilot_year=2010 (期望2010) [OK]
```

---

## 四、修复结果

### 4.1 试点城市分布

| 批次 | 年份 | 城市数 | 说明 |
|------|------|--------|------|
| 第一批 | 2010 | 49 | 含省级试点覆盖（广东、湖北、陕西、云南） |
| 第二批 | 2012 | 20 | 含省级试点覆盖（海南） |
| 第三批 | 2017 | 24 | 补全拉萨、伊宁、和田 |
| **总计** | - | **93** | 处理组 |
| **对照组** | - | **123** | 非试点城市 |

### 4.2 DID变量统计

- **总观测数**: 3,672
- **DID=1观测数**: 1,094 (29.79%)
- **DID=0观测数**: 2,578 (70.21%)

### 4.3 时间分布

| 年份 | DID=1城市数 | 占比 |
|------|-----------|------|
| 2010 | 49 | 22.7% |
| 2012 | 69 | 31.9% |
| 2017 | 93 | 43.1% |
| 2023 | 93 | 43.1% |

---

## 五、技术细节

### 5.1 省级代码映射

| 省份 | 代码前两位 | 覆盖城市数 |
|------|----------|-----------|
| 广东省 | 44 | 21 |
| 辽宁省 | 21 | 0（数据集中无辽宁地级市） |
| 湖北省 | 42 | 9 |
| 陕西省 | 61 | 5 |
| 云南省 | 53 | 8 |
| 海南省 | 46 | 2 |

### 5.2 区县级处理

| 原名称 | 映射后 | 处理方式 |
|--------|--------|----------|
| 普洱市思茅区 | 普洱市 | 删除"思茅区"，使用地级市名称 |
| 琼中黎族苗族自治县 | 琼中黎族苗族自治县 | 保持不变（数据集中可能不存在） |
| 大兴安岭地区 | 大兴安岭地区 | 保持不变 |

---

## 六、文件更新

### 6.1 数据集文件
- **文件**: `总数据集_2007-2023_最终回归版.xlsx`
- **更新**: DID变量（treat, post, did, pilot_year）已重构
- **大小**: 0.84 MB

### 6.2 试点城市名单
- **文件**: `试点城市名单.xlsx`
- **内容**: 115个城市（含批次标识）
- **格式**: city_name, pilot_year, batch

### 6.3 新增脚本
- **文件**: `py代码文件/reconstruct_did_variable.py`
- **功能**: 重构DID变量（修复版）
- **特点**:
  - 省级试点优先处理
  - 取最早年份原则
  - 完善的验证机制

---

## 七、影响评估

### 7.1 对PSM匹配的影响
- **处理组可能变化**: 部分城市年份提前，需重新运行PSM
- **匹配样本**: 建议重新运行 `propensity_score_matching.py`

### 7.2 对回归结果的影响
- **政策效应估计**: 武汉、广州、昆明等城市年份提前，可能影响系数估计
- **长期效应**: t≥+5的定义（2023-2010=13年）更准确
- **建议**: 重新运行PSM-DID回归和平行趋势检验

### 7.3 对研究结论的影响
- **更准确的时间基准**: 第二批试点从2013改为2012，时间基准更准确
- **更合理的处理组**: 省会城市年份正确，避免系统性偏差
- **更完整的样本**: 补全西部城市，提高代表性

---

## 八、下一步工作

### 8.1 必须重新运行的分析
1. ✅ **DID变量重构**（已完成）
2. ⏳ **PSM匹配** - 需重新运行
   ```bash
   py py代码文件/propensity_score_matching.py
   ```
3. ⏳ **PSM-DID回归** - 需重新运行
   ```bash
   py py代码文件/psm_did_regression.py
   ```
4. ⏳ **平行趋势检验** - 需重新运行
   ```bash
   py py代码文件/event_study_parallel_trends.py
   ```

### 8.2 可选的补充分析
1. **机制检验** - 重新测试工业结构渠道
2. **异质性分析** - 按批次、区域、城市 size 分组
3. **安慰剂检验** - 随机分配处理组
4. **排除同期政策** - Smart City, Innovative City

---

## 九、技术总结

### 9.1 核心改进点
1. ✅ **取最早年份原则** - 解决省市重叠问题
2. ✅ **第二批年份修正** - 2013→2012
3. ✅ **补全遗漏城市** - 拉萨、伊宁、和田
4. ✅ **区县级映射** - 普洱市思茅区→普洱市

### 9.2 关键代码模式
```python
# 正确的赋值顺序
# 1. 省级试点优先（最早年份）
for province_code in batch_1_provinces:
    for city_name in cities_in_province:
        city_to_pilot_year[city_name] = 2010

# 2. 明确名单后处理（只赋值未赋值的）
for city_name in batch_2_cities:
    if city_name not in city_to_pilot_year:  # 关键
        city_to_pilot_year[city_name] = 2012
```

### 9.3 验证检查点
1. ✅ 关键城市年份检查（武汉、广州、昆明）
2. ✅ 省市重叠问题解决检查
3. ✅ 批次分布统计
4. ✅ DID变量时间分布

---

## 十、附录

### 10.1 完整的第一批试点省份覆盖

#### 广东省（44）- 21个城市
广州市、深圳市、珠海市、汕头市、佛山市、韶关市、湛江市、肇庆市、江门市、茂名市、惠州市、梅州市、汕尾市、河源市、阳江市、清远市、东莞市、中山市、潮州市、揭阳市、云浮市

#### 湖北省（42）- 9个城市
武汉市、黄石市、十堰市、宜昌市、襄阳市、鄂州市、荆门市、孝感市、荆州市

#### 陕西省（61）- 5个城市
西安市、铜川市、宝鸡市、咸阳市、渭南市

#### 云南省（53）- 8个城市
昆明市、曲靖市、玉溪市、保山市、昭通市、丽江市、普洱市、临沧市

#### 海南省（46）- 2个城市
海口市、三亚市

### 10.2 修复后的关键城市清单

| 城市 | 省份 | 批次 | pilot_year | 说明 |
|------|------|------|-----------|------|
| 武汉市 | 湖北 | 第一批 | 2010 | 省会，省级试点覆盖 |
| 广州市 | 广东 | 第一批 | 2010 | 省会，省级试点覆盖 |
| 昆明市 | 云南 | 第一批 | 2010 | 省会，省级试点覆盖 |
| 北京市 | - | 第二批 | 2012 | 直辖市 |
| 上海市 | - | 第二批 | 2012 | 直辖市 |
| 拉萨市 | 西藏 | 第三批 | 2017 | 新增 |
| 伊宁市 | 新疆 | 第三批 | 2017 | 新增 |
| 和田市 | 新疆 | 第三批 | 2017 | 新增 |

---

**文档结束**

**最后更新**: 2026年1月9日
**作者**: Claude Code AI Assistant
**版本**: 1.0
