# CEADs碳排放数据处理

本文件夹包含使用CEADs（China Emission Accounts and Datasets）数据进行碳排放强度计算的完整流程。

**⚠️ 重要更新（2025-01-17）**：已修复城市名称清洗Bug，V2版本新增52个观测、4个城市（吉林市、北京市、上海市）。**请使用V2版本的数据！**

## 数据源

1. **CEADs碳排放数据**: `1997-2019年290个中国城市碳排放清单 (1).xlsx`
   - 来源：CEADs (http://www.ceads.net)
   - 时间范围：1997-2019年
   - 单位：百万吨CO2
   - 城市数量：290个城市

2. **实际GDP数据**: `../原始数据/296个地级市GDP相关数据（以2000年为基期）.xlsx`
   - 时间范围：2000-2023年（本研究使用2007-2019）
   - 单位：亿元（以2000年为基期）

3. **主数据集**: `总数据集_2007-2023_完整版_无缺失FDI_修正pop_density_添加金融发展水平.xlsx`
   - 来源：主研究的完整数据集
   - 本研究截取2007-2019年子样本

## 处理流程

### Step 1: 数据探索
- 文件：`step1_explore_ceads.py`
- 内容：查看CEADs Excel文件结构，确定数据所在的工作表

### Step 2: 数据清洗
- **推荐文件**：`step2c_clean_ceads_fixed_v2.py`（V2修正版，完整流程）
- 旧文件：`step2b_clean_ceads_fixed.py`（已修复Bug，但仅输出清洗后数据）
- 内容：
  - 提取CEADs核心数据（城市、年份、排放量）
  - 时间截断：保留2007-2019年
  - 构造匹配键：去除省份前缀和城市后缀
  - 清洗实际GDP数据并构造匹配键

**关键修正**：
1. CEADs城市名包含省份前缀（如"四川成都"），需要去除前缀后才能与主数据集匹配
2. **Bug修复（2025-01-17）**：
   - **问题**：V1版本会将"吉林市"、"北京市"、"上海市"变成空字符串
   - **修复**：step2b_clean_ceads_fixed.py 和 step2c_clean_ceads_fixed_v2.py 均已修复
   - **修复逻辑**：在去除省份前缀时添加安全检查 `if remaining and len(remaining) > 0`
   - **效果**：V2版本新增52个观测、4个城市（吉林市11观测、北京市13观测、上海市13观测）

### Step 3: 数据合并
- 文件：`step3c_merge_data_fixed_v2.py`（V2修正版）
- 内容：
  - 以主数据集为左表
  - Left Join CEADs数据（通过年份+匹配键）
  - Left Join实际GDP数据（通过年份+匹配键）
  - 检查匹配率和缺失值

**匹配结果（V2版本）**：
- 总观测数：3,705
- CEADs数据匹配率：62.70%（2,323个观测）
- 涉及城市：216/285（75.79%）
- GDP数据匹配率：100%

**V1 → V2改进**：
- 新增52个观测（2,271 → 2,323）
- 新增4个城市（212 → 216）
- 修复城市：吉林市（11观测）、北京市（13观测）、上海市（13观测）

### Step 4: 计算碳排放强度
- 文件：`step4b_calculate_carbon_intensity_v2.py`（V2版本）
- 内容：
  - 单位换算：CEADs排放量（百万吨）/ GDP（亿元）→ 吨/万元
  - 公式：`carbon_intensity = (emission_million_tons / real_gdp_100m_yuan) × 100`
  - 缩尾处理：1%和99%分位数
  - 生成对数变量：`ln_carbon_intensity_ceads`

**结果（V2版本）**：
- 均值：2.76 吨/万元
- 中位数：1.87 吨/万元
- 标准差：2.41 吨/万元
- 范围：0.31 - 12.62 吨/万元（缩尾后）
- 与原有数据相关系数：0.7668

### Step 5: 描述性统计
- 文件：`step5b_descriptive_statistics_v2.py`（V2版本）
- 内容：
  - 生成完整的描述性统计报告
  - 处理组与对照组对比
  - 导出统计表

## 关键发现

### 1. 数据覆盖情况
- 总观测数：3,705
- CEADs有效观测数：2,323（62.7%）✓ V2改进
- 涉及城市数：216/285（75.8%）✓ V2改进

### 2. 碳排放强度水平
- 均值：2.76 吨/万元
- 中位数：1.87 吨/万元
- 标准差：2.41 吨/万元

### 3. 处理组与对照组差异
- 对数碳排放强度：处理组0.4101 vs 对照组0.9012
- 差异：-0.4911（-54.50%）
- **处理组的碳排放强度显著低于对照组**

### 4. 年份分布
观测数在2007-2015年相对稳定（每年172-203个），2016年后开始下降（2019年仅130个），可能与CEADs数据更新滞后有关。

## 最终输出文件

1. **`CEADs_最终数据集_2007-2019_V2.xlsx`** (推荐使用)
   - 包含所有核心变量的完整数据集
   - 20个变量，3,705个观测
   - 核心变量：
     - `carbon_intensity_ceads_winsor`: 缩尾后的碳排放强度（吨/万元）
     - `ln_carbon_intensity_ceads`: 对数碳排放强度
     - `emission_million_tons`: CEADs碳排放量（百万吨）
     - `real_gdp_100m_yuan`: 实际GDP（亿元）

2. **`CEADs_描述性统计表_V2.xlsx`**
   - 详细的描述性统计表
   - 包含全样本、处理组、对照组的均值和标准差

## 已废弃文件（V1版本，有Bug）

以下文件存在城市名称清洗Bug，导致吉林市、北京市、上海市数据丢失，**不建议使用**：
- `CEADs_最终数据集_2007-2019.xlsx`
- `CEADs_描述性统计表.xlsx`
- `CEADs_2007-2019_清洗后_修正版.xlsx`
- `合并后数据集_2007-2019_修正版.xlsx`

## Bug说明

### 问题描述
V1版本的城市名称清洗逻辑存在严重Bug：当城市名与省名/直辖市名相同时，去除省份前缀后会导致空字符串。

**受影响城市**：
- `"吉林市"` → 去后缀变成 `"吉林"` → 去前缀变成 **空字符串** `""`
- `"北京市"` → 去后缀变成 `"北京"` → 去前缀变成 **空字符串** `""`
- `"上海市"` → 去后缀变成 `"上海"` → 去前缀变成 **空字符串** `""`
- `"海南州"` → 去后缀变成 `"海南"` → 去前缀变成 **空字符串** `""`

### 修复方法
在去除省份前缀时，添加安全检查：**只有当去除省份前缀后剩余字符串非空时才执行去除操作**。

```python
# 修复后的逻辑
for province in sorted(provinces, key=len, reverse=True):
    if city_str.startswith(province):
        remaining = city_str[len(province):]
        # 关键修复：如果去除省份后剩余字符串非空，才执行去除
        if remaining and len(remaining) > 0:
            city_str = remaining
            break
```

### 修复效果
- V1版本：2,271个观测，212个城市
- V2版本：2,323个观测，216个城市
- **新增52个观测，4个城市**

## 中间文件（可删除）

- `CEADs_2007-2019_清洗后_修正版V2.xlsx`: 清洗后的CEADs数据
- `实际GDP_2007-2019_清洗后_修正版V2.xlsx`: 清洗后的GDP数据
- `合并后数据集_2007-2019_修正版V2.xlsx`: 合并后的原始数据（未计算碳排放强度）
- `step*.py`: 各步骤的处理脚本（V2版本）
- `check_*.py`: Bug检查脚本

## 与主数据集的对比

### 优势
1. **数据来源权威**：CEADs是国际认可的碳排放数据库
2. **时间跨度合理**：2007-2019年，覆盖政策实施前后
3. **单位标准化**：碳排放强度单位为"吨/万元"，符合经济学惯例
4. **Bug已修复**：V2版本解决了城市名称清洗问题

### 局限性
1. **时间截止于2019年**：无法评估近期政策效果（2020-2023）
2. **城市覆盖不全**：仅75.8%的城市有匹配数据
3. **观测数较少**：2,323个有效观测，远少于主数据集

## 使用建议

1. **主分析**：继续使用原有碳排放数据（时间跨度2007-2023，样本量大）
2. **稳健性检验**：使用**CEADs V2版本**数据作为替代数据源，验证结果稳健性
3. **子样本分析**：可对216个CEADs覆盖的城市进行深入分析
4. **重要**：使用V2版本数据，避免V1版本的Bug导致结果偏差

## 技术说明

### 匹配键构造
- CEADs数据：去除省份前缀（"四川成都" → "成都"）和后缀，**但保留直辖市同名城市**
- 主数据集/GDP数据：仅去除后缀（"成都市" → "成都"）

### 单位换算公式
```
碳排放强度(吨/万元) = (排放量(百万吨) / GDP(亿元)) × 100
```

推导过程：
- 1百万吨 = 100万吨
- 1亿元 = 10,000万元
- 吨/万元 = (百万吨 × 100) / (亿元 × 10,000) = (百万吨/亿元) × 0.01
- 为避免数值过小，乘以100：(百万吨/亿元) × 100

## 数据质量验证

✅ 均值在合理范围（0.5-5.0吨/万元）
✅ 与原有数据相关系数较高（0.7668）
✅ 处理组碳排放强度低于对照组（符合预期）
✅ 无极端异常值（已缩尾处理）
✅ 无空匹配键（Bug已修复）

## 版本历史

- **V1（2025-01-17 18:00）**：初始版本，存在城市名称清洗Bug
- **V2（2025-01-17 20:00）**：修复吉林市/北京市/上海市Bug，新增52个观测

## 日期

创建日期：2025年1月17日
最后更新：2025年1月17日（V2版本，Bug已修复）
