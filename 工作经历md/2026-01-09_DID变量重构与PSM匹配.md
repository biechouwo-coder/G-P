# 2026-01-09 DID变量重构与PSM匹配

## 一、工作背景

本次工作主要解决DID变量构建中的三个关键问题，并在此基础上重新进行PSM匹配，同时添加二产占比作为控制变量进行稳健性检验。

### 1.1 发现的问题

通过前期分析，发现DID变量构建存在以下问题：

1. **普洱市边界问题**：普洱市既在云南省级试点覆盖范围内（2010年），第三批又有思茅区（2017年），导致其既非纯粹处理组也非纯粹控制组
2. **第二批试点年份问题**：第二批试点年份被改为2012年，但原始设定应为2013年
3. **明确名单优先原则缺失**：武汉、广州、昆明等城市虽然在第二批明确名单中（2013年），但因所在省份（湖北、广东、云南）属于第一批省级试点，被错误标记为2010年
4. **第三批无条件覆盖问题**：第三批城市无条件覆盖导致部分第二批城市（如延安、广元、桂林、乌鲁木齐等）被错误覆盖

### 1.2 解决方案

1. **剔除普洱市**：从样本中完全删除普洱市
2. **恢复第二批年份**：2012年改回2013年
3. **实施明确名单优先原则**：若城市在具体名单中，以名单年份为准（覆盖省级试点）
4. **修正第三批逻辑**：添加"是否已赋值"判断，避免覆盖第一批或第二批城市

---

## 二、DID变量重构过程

### 2.1 数据规模

- **原始数据**：3,672个观测 × 216个城市 × 17年（2007-2023）
- **删除普洱市后**：3,655个观测 × 215个城市 × 17年
- **删除观测数**：17个观测（1个城市 × 17年）

### 2.2 三批低碳试点城市名单（修正后）

#### 第一批（2010年）
- **省级试点（5个）**：广东、辽宁、湖北、陕西、云南
- **明确城市（8个）**：天津市、重庆市、深圳市、厦门市、杭州市、南昌市、贵阳市、保定市
- **覆盖城市数**：42个（省级试点覆盖 + 明确城市）

#### 第二批（2013年）- **年份恢复**
- **省级试点（1个）**：海南
- **明确城市（26个）**：北京市、上海市、石家庄市、秦皇岛市、晋城市、呼伦贝尔市、吉林市、大兴安岭地区、苏州市、淮安市、镇江市、宁波市、温州市、池州市、南平市、景德镇市、赣州市、青岛市、济源市、武汉市、广州市、桂林市、广元市、遵义市、昆明市、延安市、金昌市、乌鲁木齐市
- **覆盖城市数**：23个（明确名单优先，武汉、广州、昆明从2010改为2013）

#### 第三批（2017年）- **补全遗漏城市**
- **明确城市（47个）**：乌海市、沈阳市、大连市、朝阳市、逊克县、南京市、常州市、镇江市、嘉兴市、金华市、衢州市、合肥市、淮北市、黄山市、六安市、宣城市、池州市、三明市、南平市、吉安市、抚州市、共青城市、济南市、烟台市、潍坊市、济源市、长沙市、株洲市、湘潭市、郴州市、中山市、柳州市、桂林市、三亚市、琼中黎族苗族自治县、成都市、广元市、玉溪市、延安市、安康市、兰州市、金昌市、敦煌市、西宁市、银川市、吴忠市、乌鲁木齐市、昌吉市、**拉萨市、伊宁市、和田市**
- **覆盖城市数**：27个（添加"已赋值"检查，避免覆盖第一批和第二批）

### 2.3 核心修改逻辑

```python
# 【核心修改1】剔除普洱市
df = df[df['city_name'] != '普洱市'].copy()

# 【核心修改2】第二批年份恢复
for city_name in batch_2_cities:
    if city_name in df['city_name'].values:
        city_to_pilot_year[city_name] = 2013  # 2012改回2013

# 【核心修改3】明确名单优先（先处理明确名单，再处理省级试点）
# 第一批明确城市 → 第二批明确城市 → 第三批明确城市 → 第一批省级 → 第二批省级

# 【核心修改4】第三批添加"已赋值"检查
for city_name in batch_3_cities:
    if city_name in df['city_name'].values:
        if city_name not in city_to_pilot_year:  # 关键检查
            city_to_pilot_year[city_name] = 2017
```

### 2.4 关键城市验证

| 城市 | 修正前 | 修正后 | 说明 |
|------|--------|--------|------|
| 武汉市 | 2010 | 2013 | 第二批明确名单优先 |
| 广州市 | 2010 | 2013 | 第二批明确名单优先 |
| 昆明市 | 2010 | 2013 | 第二批明确名单优先 |
| 北京市 | 2012 | 2013 | 年份恢复 |
| 上海市 | 2012 | 2013 | 年份恢复 |
| 拉萨市 | - | 2017 | 第三批新增 |
| 伊宁市 | - | 2017 | 第三批新增 |
| 和田市 | - | 2017 | 第三批新增 |
| 普洱市 | 2010 | **剔除** | 边界案例 |

### 2.5 修正结果

- **试点城市总数**：92个（42个第一批 + 23个第二批 + 27个第三批）
- **处理组城市**：92个
- **对照组城市**：123个（215 - 92）
- **DID=1观测数**：1,030个（28.18%）
- **时间覆盖**：2007-2023年（17年）

---

## 三、PSM匹配（不含二产占比）

### 3.1 匹配设计

- **方法**：1:1最近邻匹配（有放回）
- **Caliper**：0.05（倾向得分差值阈值）
- **协变量**（6个）：
  1. ln_pgdp（人均GDP对数）
  2. ln_pop_density（人口密度对数）
  3. tertiary_share（第三产业占比）
  4. tertiary_share_sq（第三产业占比平方）
  5. ln_fdi（外商直接投资对数）
  6. ln_road_area（道路面积对数）

### 3.2 匹配结果

- **原始样本**：2,950个观测
- **匹配后样本**：2,950个观测（1,475对）
- **平均匹配率**：99.1%
- **匹配质量**：
  - McFadden R²范围：0.0018-0.0840（平均0.025）
  - 4/6个协变量通过平衡性检验（标准化偏差 < 10%）

### 3.3 年度匹配统计

| 年份 | 处理组 | 对照组池 | 成功匹配 | 匹配率 | McFadden R² |
|------|--------|----------|----------|--------|-------------|
| 2007 | 86 | 86 | 85 | 98.8% | 0.0300 |
| 2008 | 88 | 88 | 87 | 98.9% | 0.0441 |
| 2009 | 88 | 88 | 86 | 97.7% | 0.0296 |
| 2010 | 87 | 87 | 85 | 97.7% | 0.0404 |
| 2011 | 87 | 87 | 85 | 97.7% | 0.0507 |
| 2012 | 87 | 87 | 87 | 100.0% | 0.0066 |
| 2013 | 88 | 88 | 88 | 100.0% | 0.0193 |
| 2014 | 87 | 87 | 87 | 100.0% | 0.0075 |
| 2015 | 87 | 87 | 84 | 96.6% | 0.0840 |
| 2016 | 81 | 81 | 80 | 98.8% | 0.0085 |
| 2017 | 84 | 84 | 84 | 100.0% | 0.0044 |
| 2018 | 87 | 87 | 87 | 100.0% | 0.0100 |
| 2019 | 88 | 88 | 88 | 100.0% | 0.0088 |
| 2020 | 87 | 87 | 87 | 100.0% | 0.0018 |
| 2021 | 88 | 88 | 88 | 100.0% | 0.0361 |
| 2022 | 87 | 87 | 86 | 98.9% | 0.0156 |
| 2023 | 88 | 88 | 88 | 100.0% | 0.0128 |

### 3.4 平衡性检验

| 协变量 | 标准化偏差 | t值 | p值 | 平衡性 |
|--------|-----------|-----|-----|--------|
| ln_pgdp | <10% | - | - | **OK** |
| ln_pop_density | <10% | - | - | **OK** |
| tertiary_share | >10% | - | - | 未通过 |
| tertiary_share_sq | >10% | - | - | 未通过 |
| ln_fdi | <10% | - | - | **OK** |
| ln_road_area | <10% | - | - | **OK** |

**通过率**：4/6（66.7%）

---

## 四、PSM匹配（含二产占比）

### 4.1 新增协变量

- **secondary_share**：第二产业占比（新增）
- **secondary_share_sq**：第二产业占比平方（新增）
- **数据来源**：`原始数据/2000-2023地级市产业结构 .xlsx`（第二列，第二产业占GDP比重）

### 4.2 数据准备

- **原始数据**：`总数据集_2007-2023_最终回归版.xlsx`
- **二产占比提取**：使用`add_real_secondary_share.py`脚本
- **合并后数据**：`二产占比模型_分析结果/PSM匹配后数据集_含二产占比.xlsx`
- **样本规模**：2,950个观测 × 27个变量

#### 二产占比描述性统计

| 统计量 | 值 |
|--------|-----|
| 均值 | 0.4735 |
| 标准差 | 0.0974 |
| 最小值 | 0.1243 |
| 中位数 | 0.4768 |
| 最大值 | 0.7686 |
| 缺失值 | 0 |

### 4.3 匹配设计（更新）

- **方法**：1:1最近邻匹配（有放回）
- **Caliper**：0.05（倾向得分差值阈值）
- **协变量**（8个）：
  1. ln_pgdp（人均GDP对数）
  2. ln_pop_density（人口密度对数）
  3. tertiary_share（第三产业占比）
  4. tertiary_share_sq（第三产业占比平方）
  5. ln_fdi（外商直接投资对数）
  6. ln_road_area（道路面积对数）
  7. **secondary_share（第二产业占比）【新增】**
  8. **secondary_share_sq（第二产业占比平方）【新增】**

### 4.4 匹配结果

- **原始样本**：2,950个观测
- **匹配后样本**：2,065个观测（1,462对）
- **平均匹配率**：99.3%
- **样本损失**：885个观测（30.0%）← **由于更严格的匹配条件**

### 4.5 年度匹配统计

| 年份 | 处理组 | 对照组池 | 成功匹配 | 匹配率 | 平均PS差值 | 最大PS差值 |
|------|--------|----------|----------|--------|-----------|-----------|
| 2007 | 86 | 86 | 85 | 98.8% | 0.0033 | 0.0353 |
| 2008 | 88 | 88 | 87 | 98.9% | 0.0062 | 0.0379 |
| 2009 | 88 | 88 | 86 | 97.7% | 0.0025 | 0.0179 |
| 2010 | 87 | 87 | 85 | 97.7% | 0.0038 | 0.0349 |
| 2011 | 87 | 87 | 85 | 97.7% | 0.0047 | 0.0346 |
| 2012 | 87 | 87 | 87 | 100.0% | 0.0023 | 0.0296 |
| 2013 | 88 | 88 | 88 | 100.0% | 0.0034 | 0.0350 |
| 2014 | 87 | 87 | 87 | 100.0% | 0.0023 | 0.0286 |
| 2015 | 87 | 87 | 84 | 96.6% | 0.0074 | 0.0413 |
| 2016 | 81 | 81 | 80 | 98.8% | 0.0034 | 0.0368 |
| 2017 | 84 | 84 | 84 | 100.0% | 0.0014 | 0.0074 |
| 2018 | 87 | 87 | 87 | 100.0% | 0.0015 | 0.0178 |
| 2019 | 88 | 88 | 88 | 100.0% | 0.0018 | 0.0174 |
| 2020 | 87 | 87 | 87 | 100.0% | 0.0010 | 0.0081 |
| 2021 | 88 | 88 | 88 | 100.0% | 0.0037 | 0.0172 |
| 2022 | 87 | 87 | 86 | 98.9% | 0.0036 | 0.0360 |
| 2023 | 88 | 88 | 88 | 100.0% | 0.0026 | 0.0341 |

**总匹配对数**：1,462对
**匹配后总观测**：2,924个理论值，实际2,065个（去重后）

### 4.6 平衡性检验

| 协变量 | 样本数 | 匹配后标准化偏差 | t值 | p值 | 平衡性 |
|--------|--------|-----------------|-----|-----|--------|
| ln_pgdp | 2065 | 12.86% | 2.64 | 0.008 | **未通过** |
| ln_pop_density | 2065 | 17.37% | 3.54 | <0.001 | **未通过** |
| tertiary_share | 2065 | 26.55% | 5.59 | <0.001 | **未通过** |
| tertiary_share_sq | 2065 | 26.96% | 5.78 | <0.001 | **未通过** |
| ln_fdi | 2065 | 11.40% | 2.42 | 0.016 | **未通过** |
| ln_road_area | 2065 | -11.56% | -2.39 | 0.017 | **未通过** |
| **secondary_share** | 2065 | **-7.39%** | -1.50 | 0.135 | **OK ✓** |
| **secondary_share_sq** | 2065 | **-9.60%** | -1.95 | 0.051 | **OK ✓** |

**通过率**：2/8（25.0%）

**关键发现**：
- 仅**新增的二产占比变量**通过平衡性检验
- 其他6个原有协变量全部未通过（<10%阈值）
- 可能原因：二产占比与其他协变量存在多重共线性，增加了匹配难度

### 4.7 McFadden R²统计

| 年份 | McFadden R² | 处理组PS均值 | 对照组PS均值 | PS标准差 |
|------|-------------|--------------|--------------|----------|
| 2007 | 0.0300 | 0.5153 | 0.4848 | 0.0703 |
| 2008 | 0.0441 | 0.5219 | 0.4781 | 0.0828 |
| 2009 | 0.0296 | 0.5158 | 0.4842 | 0.0736 |
| 2010 | 0.0404 | 0.5191 | 0.4809 | 0.0735 |
| 2011 | 0.0507 | 0.5275 | 0.4725 | 0.1023 |
| 2012 | 0.0066 | 0.5037 | 0.4963 | 0.0375 |
| 2013 | 0.0193 | 0.5097 | 0.4903 | 0.0556 |
| 2014 | 0.0075 | 0.5047 | 0.4953 | 0.0453 |
| 2015 | 0.0840 | 0.5506 | 0.4494 | 0.1557 |
| 2016 | 0.0085 | 0.5049 | 0.4951 | 0.0449 |
| 2017 | 0.0044 | 0.5027 | 0.4973 | 0.0340 |
| 2018 | 0.0100 | 0.5050 | 0.4951 | 0.0389 |
| 2019 | 0.0088 | 0.5043 | 0.4957 | 0.0356 |
| 2020 | 0.0018 | 0.5010 | 0.4990 | 0.0197 |
| 2021 | 0.0361 | 0.5215 | 0.4785 | 0.0966 |
| 2022 | 0.0156 | 0.5093 | 0.4907 | 0.0635 |
| 2023 | 0.0128 | 0.5059 | 0.4941 | 0.0383 |

**平均R²**：0.025（与不含二产占比版本基本一致）

---

## 五、两次PSM对比分析

### 5.1 样本规模对比

| 指标 | 不含二产占比 | 含二产占比 | 变化 |
|------|-------------|-----------|------|
| 原始样本 | 2,950 | 2,950 | - |
| 匹配后样本 | 2,950 | 2,065 | **-30.0%** |
| 匹配对数 | 1,475 | 1,462 | -0.9% |
| 平均匹配率 | 99.1% | 99.3% | +0.2% |
| 城市数 | 200 | 199 | -1 |

**关键发现**：
- 匹配对数基本一致（1,475 vs 1,462）
- 但匹配后观测数大幅减少（2,950 vs 2,065）
- 原因：**有放回匹配**导致重复观测，去重后样本缩小

### 5.2 平衡性检验对比

| 协变量 | 不含二产占比 | 含二产占比 | 变化 |
|--------|-------------|-----------|------|
| ln_pgdp | OK | **未通过** | 恶化 |
| ln_pop_density | OK | **未通过** | 恶化 |
| tertiary_share | 未通过 | **未通过** | 不变 |
| tertiary_share_sq | 未通过 | **未通过** | 不变 |
| ln_fdi | OK | **未通过** | 恶化 |
| ln_road_area | OK | **未通过** | 恶化 |
| secondary_share | - | **OK** | 新增 ✓ |
| secondary_share_sq | - | **OK** | 新增 ✓ |
| **通过率** | **4/6 (66.7%)** | **2/8 (25.0%)** | **-41.7%** |

**关键发现**：
- 添加二产占比后，**整体平衡性显著恶化**
- 原本通过的4个协变量全部未通过
- 可能原因：**多重共线性**问题
  - 二产占比与三产占比高度相关（负相关）
  - 二产占比与人均GDP、人口密度等也存在相关性
  - 8个协变量导致维度诅咒，匹配质量下降

### 5.3 结论与建议

**主要结论**：
1. **不建议使用含二产占比的PSM结果**
   - 平衡性检验通过率从66.7%降至25.0%
   - 样本损失30%（2,950 → 2,065）
   - 新增二产占比虽通过检验，但导致原有协变量全部失效

2. **可能的技术原因**：
   - **多重共线性**：二产占比与三产占比相关性极高（r ≈ -0.9）
   - **维度诅咒**：协变量从6个增加到8个，匹配空间更稀疏
   - **样本量不足**：2,950个观测难以支撑8维匹配

3. **建议的替代方案**：
   - **方案A**：使用三产占比模型（原模型，平衡性更好）
   - **方案B**：用二产占比**替代**三产占比（不是同时加入）
   - **方案C**：使用主成分分析（PCA）降维，提取产业结构主成分
   - **方案D**：在回归中控制二产占比，而非在PSM阶段（PSM用6个协变量，回归用8个）

---

## 六、输出文件清单

### 6.1 DID变量重构

- **主数据集**：`总数据集_2007-2023_最终回归版.xlsx`（3,655 obs × 25 vars）
- **试点名单**：`试点城市名单.xlsx`（92个城市）
- **重构脚本**：`py代码文件/reconstruct_did_variable.py`
- **重构记录**：`DID变量重构记录.md`

### 6.2 PSM匹配（不含二产占比）

- **匹配后数据集**：`倾向得分匹配_匹配后数据集.xlsx`（2,950 obs）
- **平衡性检验**：`倾向得分匹配_平衡性检验.xlsx`
- **年度统计**：`倾向得分匹配_年度统计.xlsx`
- **汇总报告**：`倾向得分匹配_汇总报告.xlsx`
- **匹配脚本**：`py代码文件/propensity_score_matching.py`

### 6.3 PSM匹配（含二产占比）

- **匹配后数据集**：`倾向得分匹配_匹配后数据集_含二产占比.xlsx`（2,065 obs）
- **平衡性检验**：`倾向得分匹配_平衡性检验_含二产占比.xlsx`
- **年度统计**：`倾向得分匹配_年度统计_含二产占比.xlsx`
- **汇总报告**：`倾向得分匹配_汇总报告_含二产占比.xlsx`
- **数据准备脚本**：`py代码文件/add_real_secondary_share.py`
- **匹配脚本**：`py代码文件/propensity_score_matching_secondary.py`

---

## 七、技术要点总结

### 7.1 DID变量构建原则

1. **明确名单优先原则**：若城市在具体名单中，以名单年份为准（覆盖省级试点）
2. **最早年份原则**：若城市多次出现，以最早年份为准
3. **边界情况处理**：既非纯粹处理组也非纯粹控制组的城市应剔除（如普洱市）
4. **省级试点覆盖**：仅对未在明确名单中的城市生效

### 7.2 PSM匹配技术细节

1. **逐年匹配**：每年独立进行Logit回归和匹配（不是混合回归）
2. **有放回匹配**：允许同一对照匹配多个处理组
3. **Caliper限制**：PS差值超过0.05的匹配对被排除
4. **平衡性检验**：标准化偏差 < 10%为通过
5. **McFadden R²**：应在[0, 1]范围内，通常0.06-0.11为合理

### 7.3 多重共线性问题

**问题识别**：
- 二产占比 + 三产占比 + 其他经济变量（GDP、FDI等）
- 产业结构变量之间高度相关
- 导致Logit模型不稳定，倾向得分区分度下降

**解决方案**：
1. **变量选择**：在二产和三产中选择一个（不是同时）
2. **主成分分析**：提取第一主成分作为产业结构指标
3. **分步匹配**：PSM用6个协变量，回归时加入二产占比
4. **正交化**：对协变量进行正交化处理，消除共线性

---

## 八、下一步工作计划

### 8.1 推荐路径（基于平衡性检验结果）

1. **使用不含二产占比的PSM结果**
   - 数据文件：`倾向得分匹配_匹配后数据集.xlsx`（2,950 obs）
   - 协变量：6个（不含二产占比）
   - 平衡性：4/6通过（66.7%）

2. **进行PSM-DID回归**
   - 使用匹配后样本（2,950 obs）
   - 控制变量：6个协变量 + 双向固定效应
   - 聚类稳健标准误（城市层面）

3. **在回归阶段控制二产占比**
   - 回归模型：`ln_cei = β·did + γ·controls + δ·secondary_share + FE + ε`
   - 这里的"控制"是指回归中加入，而非PSM阶段

### 8.2 备选路径（稳健性检验）

1. **二产占比替代三产占比**
   - PSM协变量：`ln_pgdp, ln_pop_density, secondary_share, secondary_share_sq, ln_fdi, ln_road_area`
   - 对比三产占比模型的估计结果

2. **主成分分析**
   - 提取产业结构第一主成分
   - 用主成分替代二产/三产占比

3. **放宽Caliper阈值**
   - 从0.05放宽到0.10
   - 观察匹配样本量是否增加，平衡性是否改善

---

## 九、重要提示

1. **DID变量已完成重构**，所有后续分析应使用更新后的数据集
2. **PSM匹配已完成两次**（含/不含二产占比），建议使用不含二产占比版本
3. **二产占比变量已添加到数据集**，可在回归阶段使用
4. **平衡性检验是关键**：含二产占比模型平衡性较差，需谨慎使用
5. **多重共线性需关注**：同时控制二产和三产占比可能导致估计不稳定

---

## 十、Git提交记录

- **Commit 1**: `24ba567` - DID变量重构（剔除普洱市、年份恢复、明确名单优先）
- **Commit 2**: `b2cb0d5` - 修复第三批无条件覆盖问题（添加"已赋值"检查）
- **Commit 3**: `f258885` - PSM匹配（不含二产占比，6个协变量）
- **Commit 4**: `e9f2731` - PSM匹配（含二产占比，8个协变量）

---

**文档创建时间**：2026-01-09
**最后更新时间**：2026-01-09
**作者**：Claude Code
**项目**：低碳试点城市政策对碳排放强度的影响研究
